#!/bin/sh

if ! test -e /etc/ram.conf; then
 echo "/etc/ram.conf not found"
 exit
fi

source /etc/ram.conf

if ! `/bin/mount -o remount,rw /system`; then                         
 if ! `/sbin/mount -o remount,rw /system`; then                       
  if ! `/system/xbin/mount -o remount,rw /system`; then   
   if ! `/system/bin/mount -o remount,rw /system`; then   
    if ! `mount -o remount,rw /system`; then  
     echo "Could not mount /system/etc/ rw"             
     exit                                               
fi;fi;fi;fi;fi                                          

if test -e /data/local.prop;then
 if ! `grep -q "" /init.rc`; then 
 #wouldn't it be nice if ROMS populated their busybox symlinks consistently so I could just use "which"?
  echo "no grep command found - try upgrading busybox?"
  exit
 fi
 grep -v _APP_ /data/local.prop > /data/local.prop.tmp
 grep -v SECONDARY_SERVER_ /data/local.prop.tmp > /data/local.prop
 rm /data/local.prop.tmp 
fi
                                                    
echo ro.FOREGROUND_APP_ADJ=$FOREGROUND_APP_ADJ >> /data/local.prop
echo ro.VISIBLE_APP_ADJ=$VISIBLE_APP_ADJ >> /data/local.prop      
echo ro.PERCEPTIBLE_APP_ADJ=$PERCEPTIBLE_APP_ADJ >> /data/local.prop
echo ro.HEAVY_WEIGHT_APP_ADJ=$HEAVY_WEIGHT_APP_ADJ >> /data/local.prop
echo ro.SECONDARY_SERVER_ADJ=$SECONDARY_SERVER_ADJ >> /data/local.prop
echo ro.BACKUP_APP_ADJ=$BACKUP_APP_ADJ >> /data/local.prop            
echo ro.HOME_APP_ADJ=$HOME_APP_ADJ >> /data/local.prop                
echo ro.HIDDEN_APP_MIN=$HIDDEN_APP_MIN >> /data/local.prop            
echo ro.EMPTY_APP_ADJ=$EMPTY_APP_ADJ >> /data/local.prop              
echo ro.FOREGROUND_APP_MEM=$FOREGROUND_APP_MEM >> /data/local.prop    
echo ro.VISIBLE_APP_MEM=$VISIBLE_APP_MEM >> /data/local.prop          
echo ro.PERCEPTIBLE_APP_MEM=$PERCEPTIBLE_APP_MEM >> /data/local.prop  
echo ro.HEAVY_WEIGHT_APP_MEM=$HEAVY_WEIGHT_APP_MEM >> /data/local.prop
echo ro.SECONDARY_SERVER_MEM=$SECONDARY_SERVER_MEM >> /data/local.prop
echo ro.BACKUP_APP_MEM=$BACKUP_APP_MEM >> /data/local.prop            
echo ro.HOME_APP_MEM=$HOME_APP_MEM >> /data/local.prop                
echo ro.HIDDEN_APP_MEM=$HIDDEN_APP_MEM >> /data/local.prop            
echo ro.EMPTY_APP_MEM=$EMPTY_APP_MEM >> /data/local.prop              
                                                                      
if test -e /etc/init.d/S999ramset; then                 
 rm /etc/init.d/S999ramset                              
fi                                                                                        

for i in `grep -l lowmemorykiller /system/etc/init.d/*`; do
 chmod 600 $i
done 

echo "# This file is autogenerated - any changes will be overwritten. Edit /etc/ram.conf instead" > /etc/init.d/S999ramset 
if ! test -z $LMK_ADJ; then echo "echo $LMK_ADJ > /sys/module/lowmemorykiller/parameters/adj" >> /etc/init.d/S999ramset;fi
if ! test -z $LMK_MINFREE; then echo "echo $LMK_MINFREE > /sys/module/lowmemorykiller/parameters/minfree" >> /etc/init.d/S999ramset;fi
if ! test -z $SWAPPINESS; then echo "echo $SWAPPINESS > /proc/sys/vm/swappiness" >> /etc/init.d/S999ramset;fi
if ! test -z $VFS_CACHE_PRESSURE; then echo "echo $VFS_CACHE_PRESSURE > /proc/sys/vm/vfs_cache_pressure" >> /etc/init.d/S999ramset;fi
if ! test -z $DIRTY_RATIO; then echo "echo $DIRTY_RATIO > /proc/sys/vm/dirty_ratio" >> /etc/init.d/S999ramset;fi
if ! test -z $DIRTY_BACKGROUND_RATIO; then echo "echo $DIRTY_BACKGROUND_RATIO > /proc/sys/vm/dirty_background_ratio" >> /etc/init.d/S999ramset;fi
if ! test -z $DIRTY_EXPIRE_CENTISECS; then echo "echo $DIRTY_EXPIRE_CENTISECS > /proc/sys/vm/dirty_expire_centisecs" >> /etc/init.d/S999ramset;fi
if ! test -z $DIRTY_WRITEBACK_CENTISECS; then echo "echo $DIRTY_WRITEBACK_CENTISECS > /proc/sys/vm/dirty_writeback_centisecs" >> /etc/init.d/S999ramset;fi
if ! test -z $MIN_FREE_ORDER_SHIFT; then echo "echo $MIN_FREE_ORDER_SHIFT > /proc/sys/vm/min_free_order_shift" >> /etc/init.d/S999ramset;fi
if ! test -z $PAGE_CLUSTER; then echo "echo $PAGE_CLUSTER > /proc/sys/vm/page-cluster" >> /etc/init.d/S999ramset;fi

chmod 777 /etc/init.d/S999ramset

if ! `/bin/mount -o remount,ro /system`; then
 if ! `/sbin/mount -o remount,ro /system`; then
  if ! `/system/xbin/mount -o remount,ro /system`; then
   if ! `/system/bin/mount -o remount,ro /system`; then
    mount -o remount,ro /system
fi;fi;fi;fi

